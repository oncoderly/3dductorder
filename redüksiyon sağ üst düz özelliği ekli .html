<!DOCTYPE html><html lang="tr"><head><meta charset="utf-8"/><title>Three.js – Taper Prizma (cm) • Kısa</title><style>html,body{height:100%;margin:0;overflow:hidden;background:#0b0e12}#hud{position:absolute;top:10px;left:10px;z-index:10;color:#e6edf3;font:13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}.label{color:inherit;font-weight:700;text-shadow:0 0 2px #000}</style><script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"}}</script></head><body><div id="hud">Sol tık: döndür • Sağ tık: kaydır • Tekerlek: zoom</div><canvas id="c"></canvas><script type="module">import * as THREE from 'three';import { OrbitControls } from 'three/addons/controls/OrbitControls.js';import { CSS2DRenderer,CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.19/+esm';
// ===== KURULUM KISA =====
const C=document.getElementById('c'),R=new THREE.WebGLRenderer({canvas:C,antialias:true,alpha:true});R.setSize(innerWidth,innerHeight);R.setPixelRatio(Math.min(2,devicePixelRatio));const S=new THREE.Scene(),Cam=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,.01,1e4);Cam.position.set(3.2,1.9,3.2);S.add(Cam);S.add(new THREE.HemisphereLight(0xffffff,0x101018,.9));const DL=new THREE.DirectionalLight(0xffffff,.7);DL.position.set(3,5,4);S.add(DL);const Ctrl=new OrbitControls(Cam,R.domElement);Ctrl.enableDamping=true;const Grid=new THREE.GridHelper(10,20,0x2a2e35,0x1a1d23);S.add(Grid);const Ax=new THREE.AxesHelper(1);S.add(Ax);const LBL=new CSS2DRenderer();LBL.setSize(innerWidth,innerHeight);Object.assign(LBL.domElement.style,{position:'absolute',top:'0',pointerEvents:'none'});document.body.appendChild(LBL.domElement);const hud=document.getElementById('hud'),areaEl=document.createElement('div');areaEl.style.marginTop='6px';hud.appendChild(areaEl);
// ===== PARAM =====
const P={W1:100,H1:80,W2:60,H2:40,L:120,t:0.12,steps:120,edgeSegs:6,showEdges:true,showDims:true,showFlange:true,flangeLip:3,flangeThick:0.6,metalRough:0.35,metalness:0.85,showAxis:false,showGrid:true,dimOffsetCm:1.5,arrowHeadCm:4,arrowRadiusCm:1.2,extLenCm:15,extGapCm:1,labelOffsetCm:0.5,showSideLabels:true,colorW1:'#007bff',colorH1:'#ffd400',colorW2:'#00c853',colorH2:'#ff8c00',colorL:'#00bcd4',areaIncludeFlange:false,wastePercent:25,modeW:'central',modeH:'central',offWcm:0,offHcm:0};
// ===== MALZEME & GRUP =====
const metalMat=new THREE.MeshPhysicalMaterial({color:0xbfc7d2,roughness:P.metalRough,metalness:P.metalness,clearcoat:0.5,clearcoatRoughness:0.25,side:THREE.DoubleSide}),flangeMat=new THREE.MeshPhysicalMaterial({color:0x9aa3ad,roughness:0.6,metalness:0.9}),edgeMat=new THREE.LineBasicMaterial({color:0x3a3f46});const G=new THREE.Group(),GF=new THREE.Group(),GD=new THREE.Group();S.add(G,GF,GD);
// ===== YRD =====
const V=(x=0,y=0,z=0)=>new THREE.Vector3(x,y,z),cm=v=>v*.01,CL=g=>{while(g.children.length){const c=g.children.pop();c.geometry?.dispose?.();(Array.isArray(c.material)?c.material?[c.material]:[]:[c.material]).forEach(m=>m?.dispose?.())}},AL=(t,p,col)=>{const d=document.createElement('div');d.className='label';d.textContent=t;if(col)d.style.color=col;const o=new CSS2DObject(d);o.position.copy(p);S.add(o);GD.add(o);return o},AB=(p1,p2,col=0xff4d4d,h=.04,r=.01)=>{const ln=new THREE.Line(new THREE.BufferGeometry().setFromPoints([p1,p2]),new THREE.LineBasicMaterial({color:col}));const dir=V().subVectors(p2,p1).normalize(),mk=(q,p)=>{const c=new THREE.Mesh(new THREE.ConeGeometry(r,h,12),new THREE.MeshBasicMaterial({color:col}));c.quaternion.copy(q);c.position.copy(p);return c},q2=new THREE.Quaternion().setFromUnitVectors(V(0,1,0),dir),q1=new THREE.Quaternion().setFromUnitVectors(V(0,1,0),dir.clone().negate());GD.add(ln,mk(q2,p2),mk(q1,p1))},DLn=(p1,p2,off,label,col)=>{const n=off.clone().normalize(),gap=cm(P.extGapCm),ext=cm(P.extLenCm),s1=p1.clone().add(n.clone().multiplyScalar(gap)),e1=p1.clone().add(n.clone().multiplyScalar(gap+ext)),s2=p2.clone().add(n.clone().multiplyScalar(gap)),e2=p2.clone().add(n.clone().multiplyScalar(gap+ext));const m=new THREE.LineBasicMaterial({color:new THREE.Color(col||0xff4d4d)});GD.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([s1,e1]),m),new THREE.Line(new THREE.BufferGeometry().setFromPoints([s2,e2]),m));const h=cm(P.arrowHeadCm),r=cm(P.arrowRadiusCm),dir=V().subVectors(e2,e1).normalize(),offm=cm(P.dimOffsetCm),a1=e1.clone().add(dir.clone().multiplyScalar(offm)),a2=e2.clone().add(dir.clone().multiplyScalar(-offm));AB(a1,a2,col,h,r);return AL(label,a1.clone().add(a2).multiplyScalar(.5).add(n.clone().multiplyScalar(cm(P.labelOffsetCm))),col)},TA=(a,b,c)=>{const ab=V().subVectors(b,a),ac=V().subVectors(c,a);return ab.cross(ac).length()*.5},FL=(Wm,Hm,lip,th)=>{const sh=new THREE.Shape([new THREE.Vector2(-Wm/2-lip,-Hm/2-lip),new THREE.Vector2(Wm/2+lip,-Hm/2-lip),new THREE.Vector2(Wm/2+lip,Hm/2+lip),new THREE.Vector2(-Wm/2-lip,Hm/2+lip)]),hole=new THREE.Path([new THREE.Vector2(-Wm/2,-Hm/2),new THREE.Vector2(Wm/2,-Hm/2),new THREE.Vector2(Wm/2,Hm/2),new THREE.Vector2(-Wm/2,Hm/2)]);sh.holes.push(hole);const g=new THREE.ExtrudeGeometry(sh,{depth:th,bevelEnabled:false});g.center();const m=new THREE.Mesh(g,flangeMat);m.add(new THREE.LineSegments(new THREE.EdgesGeometry(g),edgeMat));return m};
// ===== BUILD =====
function B(){try{CL(G);CL(GF);CL(GD);document.querySelectorAll('.label').forEach(e=>e.remove());const W1=cm(P.W1),H1=cm(P.H1),W2=cm(P.W2),H2=cm(P.H2),L=cm(P.L),t=cm(P.t),lip=cm(P.flangeLip),fth=cm(P.flangeThick),n=V(1,0,0),b=V(0,1,0),tz=V(0,0,1),per=Math.max(2,Math.floor(P.edgeSegs)),N=per*4,vs=[],idx=[],Rout=[],Rin=[],LERP=(a,b,u)=>a+(b-a)*u,rect=(p,hw,hh)=>{const r=[];for(let s=0;s<per;s++)r.push(p.clone().add(n.clone().multiplyScalar(-hw+(2*hw)*(s/(per-1)))).add(b.clone().multiplyScalar(-hh)));for(let s=0;s<per;s++)r.push(p.clone().add(n.clone().multiplyScalar(hw)).add(b.clone().multiplyScalar(-hh+(2*hh)*(s/(per-1)))));for(let s=0;s<per;s++)r.push(p.clone().add(n.clone().multiplyScalar(hw-(2*hw)*(s/(per-1)))).add(b.clone().multiplyScalar(hh)));for(let s=0;s<per;s++)r.push(p.clone().add(n.clone().multiplyScalar(-hw)).add(b.clone().multiplyScalar(hh-(2*hh)*(s/(per-1)))));return r};// Ofsetin kesit merkezine uygulanması (dinamik, W/H'e bağlı)
const offWx=cm(P.offWcm), offHy=cm(P.offHcm);
const left0W=-W2/2, right0W= W2/2;  // başlangıç sol/sağ
const bot0H =-H2/2, top0H  = H2/2;  // başlangıç alt/üst
const cx=(u,W)=> P.modeW==='flatLeft'  ? left0W + W/2 :
                P.modeW==='flatRight' ? right0W - W/2 :
                P.modeW==='value'     ? offWx*u      : 0;
const cy=(u,H)=> P.modeH==='flatBottom'? bot0H  + H/2 :
                P.modeH==='flatTop'   ? top0H  - H/2 :
                P.modeH==='value'     ? offHy*u      : 0;
for(let i=0;i<=P.steps;i++){
  const u=i/P.steps; const W=LERP(W2,W1,u), H=LERP(H2,H1,u);
  const p=V( cx(u,W), cy(u,H), u*L );
  const Wi=Math.max(W-2*t,1e-5), Hi=Math.max(H-2*t,1e-5);
  Rout.push(rect(p,W/2,H/2)); Rin.push(rect(p,Wi/2,Hi/2));
}const push=r=>{for(const v of r)vs.push(v.x,v.y,v.z)};for(let i=0;i<=P.steps;i++)push(Rout[i]);const innerBase=vs.length/3;for(let i=0;i<=P.steps;i++)push(Rin[i]);const quad=(a,b,c,d)=>{idx.push(a,b,c,a,c,d)};for(let i=0;i<P.steps;i++){const b0=i*N,b1=(i+1)*N;for(let k=0;k<N;k++){const a=b0+k,bI=b0+(k+1)%N,c=b1+(k+1)%N,d=b1+k;quad(a,bI,c,d)}}for(let i=0;i<P.steps;i++){const b0=innerBase+i*N,b1=innerBase+(i+1)*N;for(let k=0;k<N;k++){const a=b0+k,bI=b0+(k+1)%N,c=b1+(k+1)%N,d=b1+k;quad(d,c,bI,a)}}const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.Float32BufferAttribute(vs,3));geo.setIndex(idx);geo.computeVertexNormals();const msh=new THREE.Mesh(geo,metalMat);G.add(msh);if(P.showEdges)G.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo,1),edgeMat));let Aout=0,Ain=0;for(let i=0;i<P.steps;i++){const r0=Rout[i],r1=Rout[i+1];for(let k=0;k<N;k++){const v00=r0[k],v01=r0[(k+1)%N],v11=r1[(k+1)%N],v10=r1[k];Aout+=TA(v00,v01,v11)+TA(v00,v11,v10)}}for(let i=0;i<P.steps;i++){const r0=Rin[i],r1=Rin[i+1];for(let k=0;k<N;k++){const v00=r0[k],v01=r0[(k+1)%N],v11=r1[(k+1)%N],v10=r1[k];Ain+=TA(v00,v01,v11)+TA(v00,v11,v10)}}let sheet=.5*(Aout+Ain);if(P.areaIncludeFlange){GF.children.forEach(m=>{if(m.geometry){const g=m.geometry,p=g.attributes.position.array,I=g.index?g.index.array:null;let A=0;const a=V(),b2=V(),c2=V(),rd=(i,o)=>o.set(p[3*i],p[3*i+1],p[3*i+2]);if(I){for(let i=0;i<I.length;i+=3){rd(I[i],a);rd(I[i+1],b2);rd(I[i+2],c2);A+=TA(a,b2,c2)}}else{for(let i=0;i<p.length;i+=9){a.set(p[i],p[i+1],p[i+2]);b2.set(p[i+3],p[i+4],p[i+5]);c2.set(p[i+6],p[i+7],p[i+8]);A+=TA(a,b2,c2)}}sheet+=A}})}const waste=sheet*(1+((P.wastePercent||0)/100));if(P.showFlange){const p0=V(cx(0,W2),cy(0,H2),0),p1=V(cx(1,W1),cy(1,H1),L),F0=FL(W2,H2,lip,fth),F1=FL(W1,H1,lip,fth),pl=(o,p,t,n,b)=>{const M=new THREE.Matrix4().makeBasis(n.clone(),b.clone(),t.clone()),Q=new THREE.Quaternion().setFromRotationMatrix(M);o.position.copy(p);o.quaternion.copy(Q)};pl(F0,p0.clone().add(tz.clone().multiplyScalar(-fth*.5)),tz,n,b);pl(F1,p1.clone().add(tz.clone().multiplyScalar( fth*.5)),tz,n,b);GF.add(F0,F1)}if(P.showDims){const p0=V(cx(0,W2),cy(0,H2),0), p1=V(cx(1,W1),cy(1,H1),L),x0L=n.clone().multiplyScalar(-W2/2),x0R=n.clone().multiplyScalar(W2/2),y0T=b.clone().multiplyScalar(H2/2),y0B=b.clone().multiplyScalar(-H2/2);DLn(p0.clone().add(x0L).add(y0T),p0.clone().add(x0R).add(y0T),b,`W2 = ${P.W2.toFixed(1)} cm`,P.colorW2);DLn(p0.clone().add(x0R).add(y0B),p0.clone().add(x0R).add(y0T),n,`H2 = ${P.H2.toFixed(1)} cm`,P.colorH2);const x1L=n.clone().multiplyScalar(-W1/2),x1R=n.clone().multiplyScalar(W1/2),y1T=b.clone().multiplyScalar(H1/2),y1B=b.clone().multiplyScalar(-H1/2);DLn(p1.clone().add(x1L).add(y1T),p1.clone().add(x1R).add(y1T),b,`W1 = ${P.W1.toFixed(1)} cm`,P.colorW1);DLn(p1.clone().add(x1R).add(y1B),p1.clone().add(x1R).add(y1T),n,`H1 = ${P.H1.toFixed(1)} cm`,P.colorH1);const left0=p0.x-W2/2,left1=p1.x-W1/2,bottom0=p0.y-H2/2,bottom1=p1.y-H1/2;const xr=Math.max(left0,left1),yr=Math.max(bottom0,bottom1);DLn(V(xr,yr,0),V(xr,yr,L),n.clone().negate(),`L = ${P.L.toFixed(1)} cm`,P.colorL)}if(P.showSideLabels){const mid=V(0,0,L*.5),ox=(W1+W2)*.25,oy=(H1+H2)*.25;['SAĞ','SOL','ÜST','ALT'].map((t,i)=>AL(t,[mid.clone().add(n.clone().multiplyScalar( ox)),mid.clone().add(n.clone().multiplyScalar(-ox)),mid.clone().add(b.clone().multiplyScalar( oy)),mid.clone().add(b.clone().multiplyScalar(-oy))][i])).forEach(e=>e.element.style.color='#6cf')}((o)=>{const box=new THREE.Box3().setFromObject(o),sz=box.getSize(new THREE.Vector3()),ctr=box.getCenter(new THREE.Vector3()),md=Math.max(sz.x,sz.y,sz.z),dist=md/(2*Math.tan(THREE.MathUtils.degToRad(Cam.fov/2)))*1.4,dir=V(1,.6,1).normalize();Cam.position.copy(ctr.clone().add(dir.multiplyScalar(dist)));Cam.near=dist/100;Cam.far=dist*100;Cam.updateProjectionMatrix();Ctrl.target.copy(ctr);Ctrl.update()})(G);areaEl.textContent=`Sac alanı ≈ ${sheet.toFixed(3)} m²  |  +%${(P.wastePercent||0).toFixed(1)} atık ⇒ ${waste.toFixed(3)} m²`;Ax.visible=P.showAxis;Grid.visible=P.showGrid}catch(err){console.error('[BUILD ERROR]',err);areaEl.textContent='Hata: '+err.message}};
// ===== START =====
B();
// ===== GUI =====
const gui=new GUI({title:'Parametreler'}),add=(f,o,k,a,b,s,n)=>f.add(o,k,a,b,s).name(n).onChange(B),F1=gui.addFolder('Ölçüler (cm)');[['W1',1,400,.1,'W1 (bitiş) cm'],['H1',1,400,.1,'H1 (bitiş) cm'],['W2',1,400,.1,'W2 (başlangıç) cm'],['H2',1,400,.1,'H2 (başlangıç) cm'],['L',1,1000,.1,'L (uzunluk) cm'],['t',.02,1,.01,'Sac Kalınlığı t'],['steps',8,400,1,'Yol Segmenti (steps)'],['edgeSegs',2,16,1,'Kesit Kenar Segmenti']].forEach(p=>add(F1,P,p[0],p[1],p[2],p[3],p[4]));const F2=gui.addFolder('Görünüm / Flanş');['showEdges','showDims','showFlange'].forEach(k=>F2.add(P,k).name({showEdges:'Kenar Çizgileri',showDims:'Ölçülendirme',showFlange:'Flanşları Göster'}[k]).onChange(B));add(F2,P,'flangeLip',.5,8,.1,'Flanş Payı (lip) cm');add(F2,P,'flangeThick',.2,2,.05,'Flanş Kalınlığı cm');F2.add(P,'metalRough',0,1,.01).name('Roughness').onChange(()=>{metalMat.roughness=P.metalRough;R.render(S,Cam)});F2.add(P,'metalness',0,1,.01).name('Metalness').onChange(()=>{metalMat.metalness=P.metalness;R.render(S,Cam)});F2.add(P,'showAxis').name('Eksenleri Göster').onChange(v=>Ax.visible=v);F2.add(P,'showGrid').name('Grid Göster').onChange(v=>Grid.visible=v);[['dimOffsetCm',.5,5,.1,'Ok Ucu Kısalt (cm)'],['arrowHeadCm',1,8,.1,'Ok Boyu (cm)'],['arrowRadiusCm',.5,3,.1,'Ok Kalınlığı (cm)'],['extLenCm',2,40,.5,'Uzatma Uzunluğu (cm)'],['extGapCm',.2,5,.1,'Parça Boşluğu (cm)'],['labelOffsetCm',0,5,.1,'Etiket Ofset (cm)']].forEach(p=>add(F2,P,p[0],p[1],p[2],p[3],p[4]));const F3=gui.addFolder('Renkler');[['colorW1','W1 Rengi'],['colorH1','H1 Rengi'],['colorW2','W2 Rengi'],['colorH2','H2 Rengi'],['colorL','L Rengi']].forEach(p=>F3.addColor(P,p[0]).name(p[1]).onChange(B));const FA=gui.addFolder('Alan Hesabı');FA.add(P,'areaIncludeFlange').name('Flanşları dahil et').onChange(B);FA.add(P,'wastePercent',0,100,1).name('% Atık/Pay').onChange(B);
// Ofset kontrolleri
const FO=gui.addFolder('Ofset');
FO.add(P,'modeW',{ 'Sol Düz':'flatLeft', 'Merkezi':'central', 'Sağ Düz':'flatRight', 'Değer':'value' }).name('Ofset-Genişlik').onChange(B);
FO.add(P,'offWcm',-200,200,0.1).name('Ofset-Genişlik (cm)').onChange(B);
FO.add(P,'modeH',{ 'Alt Düz':'flatBottom', 'Merkezi':'central', 'Üst Düz':'flatTop', 'Değer':'value' }).name('Ofset-Yükseklik').onChange(B);
FO.add(P,'offHcm',-200,200,0.1).name('Ofset-Yükseklik (cm)').onChange(B);
// ===== LOOP =====
addEventListener('resize',()=>{Cam.aspect=innerWidth/innerHeight;Cam.updateProjectionMatrix();R.setSize(innerWidth,innerHeight);LBL.setSize(innerWidth,innerHeight)});!function anim(){requestAnimationFrame(anim);Ctrl.update();R.render(S,Cam);LBL.render(S,Cam)}();
// ===== TEST =====
(function T(){
  const t=(n,c)=>console[c?'log':'error'](`[TEST] ${c?'PASS':'FAIL'} - ${n}`);
  t('Renderer',!!R.domElement);
  const save={...P};
  // Rebuild smoke
  const o=P.W1; P.W1=o+.1; B(); t('Rebuild',G.children.length>0); P.W1=o; B();
  // Flat edge invariants
  P.modeW='flatLeft'; P.modeH='flatBottom'; B();
  const W1m=0.01*P.W1,W2m=0.01*P.W2,H1m=0.01*P.H1,H2m=0.01*P.H2;
  const cxT=(u,W)=> -W2m/2 + W/2, cyT=(u,H)=> -H2m/2 + H/2;
  const left0=cxT(0,W2m)-W2m/2, left1=cxT(1,W1m)-W1m/2;
  const bottom0=cyT(0,H2m)-H2m/2, bottom1=cyT(1,H1m)-H1m/2;
  t('FlatLeft edge equal', Math.abs(left0-left1)<1e-9);
  t('FlatBottom edge equal', Math.abs(bottom0-bottom1)<1e-9);
  Object.assign(P,save); B();
  t('HUD',/m²/.test(areaEl.textContent));
  t('Dims group',GD.children.length>=2);
})();</script></body></html>
